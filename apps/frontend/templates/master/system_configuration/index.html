{% extends 'partial/layout.html' %}
{% block title %} | System Configuration{% endblock %}
{% block content %}
{% load static %}
{% block style %}

{% endblock %}

<!-- Page body -->
<div class="page-body">
    <div class="container-xl">
        <div class="row row-cards">
            
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">{{ page_title }}</h3>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">
                                <a  class="btn btn-primary d-none d-sm-inline-block" data-bs-toggle="modal"
                                    data-bs-target="#modal-report">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                                        viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                        stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                        <path d="M12 5l0 14" />
                                        <path d="M5 12l14 0" />
                                    </svg>
                                    Create new
                                </a>
                                <a  class="btn btn-primary d-sm-none btn-icon" data-bs-toggle="modal"
                                    data-bs-target="#modal-report" aria-label="Create new">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                                        viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                        stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                        <path d="M12 5l0 14" />
                                        <path d="M5 12l14 0" />
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body border-bottom py-3">
                        <div class="d-flex">
                            <div class="text-secondary">
                                Show 
                                <div class="mx-2 d-inline-block">
                                  <input type="text" name="page_size" class="form-control form-control-sm" value="" size="3" aria-label="Invoices count" id="page-size-input" onchange="fetchData(1)">
                                </div>
                                entries
                            </div>
                            <div class="ms-auto text-secondary">
                              Search:
                              <div class="ms-2 d-inline-block">
                                  <input type="text" name="search_filter" class="form-control form-control-sm" aria-label="Search invoice" id="system-name-input">
                              </div>
                              <button class="btn btn-primary btn-sm ms-2" onclick="fetchData(1)">Search</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table card-table table-vcenter text-nowrap datatable" id="data-entries">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>System Name</th>
                                    <th>System Type</th>
                                    <th>System IP</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data rows will be inserted dynamically here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer d-flex align-items-center" id="pagination-section">
                        <!-- Pagination section will be inserted dynamically here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block script %}
<script src="{% static 'dist/js/tabler.min.js' %}" defer></script>
<script src="{% static 'dist/js/demo.min.js' %}" defer></script>

<script>
    function fetchData(page) {
        var pageSize = $('#page-size-input').val();
        var systemName = $('#system-name-input').val();
        
        var api_url = '{{api_url}}';
        var token = '{{token}}';  
        $.ajax({
            url: api_url,
            method: 'GET',
            headers: {
                'Authorization': token
            },
            data: { page: page, page_size:pageSize, system_name:systemName  },
            success: function (data) {
                $('#page-size-input').val(data.page_size);
                renderData(data);
                renderPagination(data);
            },
            error: function (error) {
                console.error('Error fetching data:', error);
            }
        });
    }

    function renderData(data) {
        var tbody = $('#data-entries tbody');
        tbody.empty(); // Clear existing rows

        var currentPage = data.current_page; // Assuming your API response includes current page number
        var itemsPerPage = data.page_size;

        if (data.count > 0) {
            $.each(data.results, function (index, item) {
                var rowIndex = (currentPage - 1) * itemsPerPage + index + 1; // Calculate row index based on current page
                var row = '<tr>' +
                    '<td>' + rowIndex + '</td>' +
                    '<td>' + item.system_name + '</td>' +
                    '<td>' + item.system_type + '</td>' +
                    '<td>' + item.system_ip + '</td>' +
                    '</tr>';
                tbody.append(row);
            });
        } else {
            tbody.html('<tr><td colspan="4">No data available</td></tr>');
        }
    }

    function renderPagination(data) {
        var paginationSection = $('#pagination-section');
        paginationSection.empty(); // Clear existing pagination

        if (data.count > 0) {
            var paginationHtml = '<p class="m-0 text-secondary">Showing ';

            var startIdx = (data.previous ? (data.previous * data.page_size) + 1 : 1);
            var endIdx = (data.next ? (data.current_page * data.page_size) : data.count);

            paginationHtml += startIdx + ' to ' + endIdx + ' of ' + data.count + ' entries</p>' +
                '<ul class="pagination m-0 ms-auto">';

            if (data.previous) {
                paginationHtml += '<li class="page-item">' +
                    '<a href="javascript:fetchData(' + data.previous + ')" class="page-link" tabindex="-1"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M15 6l-6 6l6 6"></path></svg> prev</a>' +
                    '</li>';
            } else {
                paginationHtml += '<li class="page-item disabled">' +
                    '<a class="page-link"  tabindex="-1" aria-disabled="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M15 6l-6 6l6 6"></path></svg> prev</a>' +
                    '</li>';
            }
 
            for (var i = 1; i <= Math.ceil(data.count / data.page_size); i++) {
                if (i === data.current_page) {
                    paginationHtml += '<li class="page-item active"><a class="page-link" >' + i + '</a></li>';
                } else {
                    paginationHtml += '<li class="page-item "><a href="javascript:fetchData(' + i + ')" class="page-link">' + i + '</a></li>';
                }
            }

            if (data.next) {
                paginationHtml += '<li class="page-item">' +
                    '<a href="javascript:fetchData(' + data.next + ')" class="page-link">' +
                    'next' +
                    '<svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 6l6 6l-6 6"></path></svg>' +
                    '</a>' +
                    '</li>';
            } else {
                paginationHtml += '<li class="page-item disabled">' +
                    '<a class="page-link"  tabindex="-1" aria-disabled="true">' +
                    'next' +
                    '<svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 6l6 6l-6 6"></path></svg>' +
                    '</a>' +
                    '</li>';
            }

            paginationHtml += '</ul>';
            paginationSection.html(paginationHtml); // Use .html() instead of .append() to replace the pagination content
        }
    }
  
    $(document).ready(function () {
        // Fetch initial data
        fetchData(1);
    });
</script>
{% endblock %}
