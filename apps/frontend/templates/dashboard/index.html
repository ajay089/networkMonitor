{% extends 'partial/layout.html' %}
{% block title %} | Dashboard{% endblock %}
{% block content %}
{% load static %}
{% block style %}
{% endblock %}

<!-- Page header -->
<div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <!-- Page pre-title -->
          <h2 class="page-title">
            Dashboard 
          </h2>
        </div>
        <!-- Page title actions -->
        <!-- <div class="col-auto ms-auto d-print-none">
          <div class="btn-list">
            <span class="d-none d-sm-inline">
              <a  class="btn">
                New view
              </a>
            </span>
            <a  class="btn btn-primary d-none d-sm-inline-block" data-bs-toggle="modal" data-bs-target="#modal-report">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 5l0 14" /><path d="M5 12l14 0" /></svg>
              Create new report
            </a>
            <a  class="btn btn-primary d-sm-none btn-icon" data-bs-toggle="modal" data-bs-target="#modal-report" aria-label="Create new report">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 5l0 14" /><path d="M5 12l14 0" /></svg>
            </a>
          </div>
        </div> -->
      </div>
    </div>
  </div>
  <!-- Page body -->
  <div class="page-body">
    <div class="container-xl">
      <div class="row row-deck row-cards">
        <div class="col-sm-6 col-lg-3">
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="subheader">Current day</div>
                <div class="ms-auto lh-1">
                  <div class="dropdown">
                    <a class="text-secondary"  data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Total Traffic</a>
                   
                  </div>
                </div>
              </div>
              <div class="h1 mb-3 placeholder-glow" id="total_trafic"><div class="placeholder placeholder-xs col-2"></div></div>
              <div class="d-flex mb-2">
                <p class="mt-0 mb-0 text-sm">
                  <div class="placeholder-glow" id="last_day_trafic"><div class="placeholder placeholder-xs col-2"></div></div>
                  <span class="text-nowrap">&nbsp;&nbsp;Since last day</span>
                </p>
              </div>
              <!-- <div class="progress progress-sm">
                <div class="progress-bar bg-primary" style="width: 75%" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" aria-label="75% Complete">
                  <span class="visually-hidden">75% Complete</span>
                </div>
              </div> -->
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="subheader">Current day</div>
                <div class="ms-auto lh-1">
                  <div class="dropdown">
                    <a class="text-secondary"  data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Out-Going Requests</a>
                   
                  </div>
                </div>
              </div>
              <div class="h1 mb-3 placeholder-glow" id="total_outgoing"><div class="placeholder placeholder-xs col-2"></div></div>
              <div class="d-flex mb-2">
                <p class="mt-0 mb-0 text-sm">
                  <div class="placeholder-glow" id="last_outgoing"><div class="placeholder placeholder-xs col-2"></div></div>
                  <span class="text-nowrap">&nbsp;&nbsp;Since last day</span>
                </p>
              </div>
              <!-- <div class="progress progress-sm">
                <div class="progress-bar bg-primary" style="width: 75%" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" aria-label="75% Complete">
                  <span class="visually-hidden">75% Complete</span>
                </div>
              </div> -->
            </div>
          </div>
        </div>
        
        <div class="col-sm-6 col-lg-3">
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="subheader">Current day</div>
                <div class="ms-auto lh-1">
                  <div class="dropdown">
                    <a class="text-secondary"  data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Incoming Requests</a>
                   
                  </div>
                </div>
              </div>
              <div class="h1 mb-3 placeholder-glow" id="total_incoming"><div class="placeholder placeholder-xs col-2"></div></div>
              <div class="d-flex mb-2">
                <p class="mt-0 mb-0 text-sm">
                  <div class="placeholder-glow" id="last_incoming"><div class="placeholder placeholder-xs col-2"></div></div>
                  <span class="text-nowrap">&nbsp;&nbsp;Since last day</span>
                </p>
              </div>
              <!-- <div class="progress progress-sm">
                <div class="progress-bar bg-primary" style="width: 75%" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" aria-label="75% Complete">
                  <span class="visually-hidden">75% Complete</span>
                </div>
              </div> -->
            </div>
          </div>
        </div>

        <div class="col-sm-6 col-lg-3">
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="subheader">Current day</div>
                <div class="ms-auto lh-1">
                  <div class="dropdown">
                    <a class="text-secondary"  data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Login Attempts</a>
                   
                  </div>
                </div>
              </div>
              <div class="h1 mb-3 placeholder-glow" id="today_login_attempt"><div class="placeholder placeholder-xs col-2"></div></div>
              <div class="d-flex mb-2">
                <p class="mt-0 mb-0 text-sm">
                  <div class="placeholder-glow" id="last_month_login_attempt"><div class="placeholder placeholder-xs col-2"></div></div>
                  <span class="text-nowrap">&nbsp;&nbsp;Since last month</span>
                </p>
              </div>
              <!-- <div class="progress progress-sm">
                <div class="progress-bar bg-primary" style="width: 75%" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" aria-label="75% Complete">
                  <span class="visually-hidden">75% Complete</span>
                </div>
              </div> -->
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card">
            <div class="card-body">
              <h3 class="card-title">Firewall Security Event Severity Levels</h3>
              <div id="chart-mentions" class="chart-lg">
                <div class="card-body text-end placeholder-glow">
                  <div class="placeholder col-9 mb-3"></div>
                  <div class="placeholder placeholder-xs col-10"></div>
                  <div class="placeholder placeholder-xs col-12"></div>
                  <div class="placeholder placeholder-xs col-11"></div>
                  <div class="placeholder placeholder-xs col-8"></div>
                  <div class="placeholder placeholder-xs col-10"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card">
            <div class="card-body">
              <h3 class="card-title">Firewall Traffic and Event Summary(Last Week)</h3>
              <div id="traffic-event-chart" class="chart-lg">
                <div class="card-body text-end placeholder-glow">
                  <div class="placeholder col-9 mb-3"></div>
                  <div class="placeholder placeholder-xs col-10"></div>
                  <div class="placeholder placeholder-xs col-12"></div>
                  <div class="placeholder placeholder-xs col-11"></div>
                  <div class="placeholder placeholder-xs col-8"></div>
                  <div class="placeholder placeholder-xs col-10"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
       
        
        <div class="col-lg-4">
          <div class="card">
            <div class="card-header border-0">
              <div class="card-title">Firewall Bandwidth Consumptions</div>
            </div>
            <div class="position-relative">
              <div id="bandwidth-chart">
                <div class="card-body text-end placeholder-glow">
                  <div class="placeholder col-9 mb-3"></div>
                  <div class="placeholder placeholder-xs col-10"></div>
                  <div class="placeholder placeholder-xs col-12"></div>
                  <div class="placeholder placeholder-xs col-11"></div>
                  <div class="placeholder placeholder-xs col-8"></div>
                  <div class="placeholder placeholder-xs col-10"></div>
                </div>
              </div>
            </div>
           
          </div>
        </div>
       
       
      </div>
    </div>
  </div>


{% endblock content %}
{% block script %}
<!-- Libs JS -->
<script src="{% static 'dist/libs/apexcharts/dist/apexcharts.min.js' %}" defer></script>
<script src="{% static 'dist/libs/jsvectormap/dist/js/jsvectormap.min.js' %}" defer></script>
<script src="{% static 'dist/libs/jsvectormap/dist/maps/world.js' %}" defer></script>
<script src="{% static 'dist/libs/jsvectormap/dist/maps/world-merc.js' %}" defer></script>


<script>
  function getData(){
    var placeholder = '<div class="placeholder placeholder-xs col-2"></div>';
     $('#total_trafic').html(placeholder);
     $('#last_day_trafic').html(placeholder);

     $('#total_outgoing').html(placeholder);
     $('#last_outgoing').html(placeholder);

     $('#total_incoming').html(placeholder);
     $('#last_incoming').html(placeholder);
     
     $('#today_login_attempt').html(placeholder);
     $('#last_month_login_attempt').html(placeholder);

     var placeholder_bandwidth = '<div class="card-body text-end placeholder-glow"><div class="placeholder col-9 mb-3"></div><div class="placeholder placeholder-xs col-10"></div><div class="placeholder placeholder-xs col-12"></div><div class="placeholder placeholder-xs col-11"></div><div class="placeholder placeholder-xs col-8"></div><div class="placeholder placeholder-xs col-10"></div></div>';
     $('#bandwidth-chart').html(placeholder_bandwidth);
     $('#chart-mentions').html(placeholder_bandwidth);
     $('#traffic-event-chart').html(placeholder_bandwidth);
      var api_url = '{{api_url}}';
      var token = '{{token}}';  

      $.ajax({
          url: api_url,
          type: 'GET',
          headers: {
              'Authorization': token
          },
          success: function(data) {
              // // Handle successful response
              // console.log('API Response:', data);

              // Total Trafic
              $('#total_trafic').html(data.totalCountToday);
              if (data.isTotalCountGreater){
                var last_day_trafic = '<span class="text-success mr-2"><i class="fa fa-arrow-up"></i>'+data.pctChangeTotalCount+'%</span>';
              }else{
                var last_day_trafic = '<span class="text-success mr-2"><i class="fa fa-arrow-down"></i>0%</span>';
              }
              $('#last_day_trafic').html(last_day_trafic);
              
              //Outgoing
              $('#total_outgoing').html(data.totalOutgoingToday);
              if (data.isTotalOutgoingGreater){
                var last_outgoing = '<span class="text-success mr-2"><i class="fa fa-arrow-up"></i>'+data.pctChangeTotalOutgoing+'%</span>';
              }else{
                var last_outgoing = '<span class="text-success mr-2"><i class="fa fa-arrow-down"></i>0%</span>';
              }
              $('#last_outgoing').html(last_outgoing);
              
              //Incoming
              $('#total_incoming').html(data.totalIncomingToday);
              if (data.isTotalIncomingGreater){
                var last_incoming = '<span class="text-success mr-2"><i class="fa fa-arrow-up"></i>'+data.pctChangeTotalIncoming+'%</span>';
              }else{
                var last_incoming = '<span class="text-success mr-2"><i class="fa fa-arrow-down"></i>0%</span>';
              }
              $('#last_incoming').html(last_incoming);

              //Login Attempts
              $('#today_login_attempt').html(data.loginAttemptsToday+'%');
              if (data.isLoginAttemptsGreater){
                var last_month_login_attempt = '<span class="text-success mr-2"><i class="fa fa-arrow-up"></i>'+data.pctChangeLoginAttempts+'%</span>';
              }else{
                var last_month_login_attempt = '<span class="text-success mr-2"><i class="fa fa-arrow-down"></i>0%</span>';
              }
              $('#last_month_login_attempt').html(last_month_login_attempt);
              
              //Clear Placeholder
              $('#bandwidth-chart').html('');
              $('#chart-mentions').html('');
              $('#traffic-event-chart').html('');
              // Call function to update ApexCharts with data
              updateApexChart(data.bandwidthData);
              updateseverityLevelChart(data.level_data);
              updateTrafficEventChart(data.traffic_event_data);

              // Example event handler for legend item click (replace with actual event handling logic)
            $('#chart-mentions').on('click', '.apexcharts-legend-text', function() {
                let selectedLevel = $(this).text();
                updateChartWithLevel(levelData, selectedLevel);
            });

            

          },
          error: function(xhr, status, error) {
              // Handle errors
              openToaster("warning", error);  // Display an error message
          }
      });
  }
    $(document).ready(function() {
      var html = '<div class="text-center">';
          html += '<div class="mb-12">Dashbaord Data Loading...</div>';
          html += '<div class="progress progress-sm">';
          html += '<div class="progress-bar progress-bar-indeterminate"></div>';
          html += '</div>';
          html += '</div>';
      getData();
      // Set interval to call every 5 seconds
        // setInterval(function() {
        //   openToaster("success", html);
        //   // Call your function here
        //   getData(); 
        // }, 50000); 
    });
    

    let chart; // Global variable to hold the chart instance

    // Function to update the chart based on selected severity level
    function updateChartWithLevel(levelData, level) {
        // Extracting data for the selected level
        let dates = levelData.map(entry => entry.date);
        let levelDataSelected = levelData.map(entry => entry.level_data[level] || 0);

        // Update the series data for the chart
        chart.updateSeries([{
            name: level,
            data: levelDataSelected
        }]);

        // Update x-axis categories
        chart.updateOptions({
            xaxis: {
                categories: dates
            }
        });
    }

    // Function to initialize or update the ApexCharts instance
    function updateseverityLevelChart(levelData) {
      // Extracting initial data for all levels
      let dates = levelData.map(entry => entry.date);
      let alertData = levelData.map(entry => entry.level_data.alert || 0);
      let errorData = levelData.map(entry => entry.level_data.error || 0);
      let informationData = levelData.map(entry => entry.level_data.information || 0);
      let noticeData = levelData.map(entry => entry.level_data.notice || 0);
      let warningData = levelData.map(entry => entry.level_data.warning || 0);

      // Initialize ApexCharts if chart is not already initialized
      if (!chart) {
          chart = new ApexCharts(document.getElementById('chart-mentions'), {
              chart: {
                  type: "bar",
                  fontFamily: 'inherit',
                  height: 320,
                  parentHeightOffset: 0,
                  animations: {
                      enabled: false
                  },
                  stacked: true,
              },
              plotOptions: {
                  bar: {
                      columnWidth: '50%',
                  }
              },
              dataLabels: {
                  enabled: false,
              },
              fill: {
                  opacity: 1,
              },
              series: [
                  { name: "Alert", data: alertData },
                  { name: "Error", data: errorData },
                  { name: "Information", data: informationData },
                  { name: "Notice", data: noticeData },
                  { name: "Warning", data: warningData }
              ],
              xaxis: {
                  labels: {
                      rotate: -45
                  },
                  categories: dates,
              },
              yaxis: {
                  title: {
                      text: 'Count',
                  },
              },
              colors:['#FF4560', '#FF9F43', '#775DD0', '#17A2B8', '#FFC107'], // Example colors
              legend: {
                  show: true,
                  position: 'top',
                  horizontalAlign: 'right',
                  onItemClick: {
                      toggleDataSeries: true // Allow toggling of data series on legend click
                  },
                  onItemHover: {
                      highlightDataSeries: true
                  },
              },
              tooltip: {
                  theme: 'dark'
              },
              grid: {
                  padding: {
                      top: -20,
                      right: 0,
                      left: -4,
                      bottom: -4
                  },
                  strokeDashArray: 4,
                  xaxis: {
                      lines: {
                          show: true
                      }
                  },
              },
          });

          chart.render();
      } else {
          chart.updateOptions({
              series: [
                  { name: "Alert", data: alertData },
                  { name: "Error", data: errorData },
                  { name: "Information", data: informationData },
                  { name: "Notice", data: noticeData },
                  { name: "Warning", data: warningData }
              ],
              xaxis: {
                  categories: dates
              }
          });
      }
  }
  </script>

  <script>
    function updateApexChart(bandwidthData) {
    // Extract keys (dates) and values (bandwidth data) into arrays
    var dates = [];
    var bandwidthValues = [];

    for (var date in bandwidthData) {
        if (bandwidthData.hasOwnProperty(date)) {
            dates.push(date);
            bandwidthValues.push(bandwidthData[date]);
        }
    }

    // Initialize ApexCharts with dynamic data
    var chart = new ApexCharts(document.getElementById('bandwidth-chart'), {
        chart: {
            type: "area",
            fontFamily: 'inherit',
            height: 356,
            sparkline: {
                enabled: true
            },
            animations: {
                enabled: false
            },
            toolbar: {
                show: true, // Show toolbar
                tools: {
                    download: true, // Enable download button
                    selection: true, // Enable selection tool
                    zoom: true, // Enable zoom tool
                    zoomin: true, // Enable zoom in button
                    zoomout: true, // Enable zoom out button
                    pan: true, // Enable pan tool
                    reset: true, // Enable reset button
                },
                autoSelected: 'zoom' // Initially select zoom tool
            },
        },
        dataLabels: {
            enabled: true, // Enable data labels
            offsetY: 0, // Offset from series
            style: {
                fontSize: '12px',
                colors: ["#304758"]
            },
            position: 'top' // Position labels above points
        },
        fill: {
            opacity: .16,
            type: 'solid'
        },
        stroke: {
            width: 2,
            lineCap: "round",
            curve: "smooth",
        },
        series: [{
            name: "Bandwidth",
            data: bandwidthValues // Use bandwidthValues array for chart data
        }],
        tooltip: {
            theme: 'dark'
        },
        grid: {
            strokeDashArray: 4,
        },
        xaxis: {
            labels: {
                padding: 0,
            },
            tooltip: {
                enabled: false
            },
            axisBorder: {
                show: false,
            },
            type: 'datetime',
            categories: dates // Use dates array for x-axis categories
        },
        yaxis: {
            labels: {
                padding: 0
            },
        },
        colors: ["#007BFF"], // Example color
        legend: {
            show: false,
        },
        point: {
            show: false
        },
    });

    chart.render();
}

</script>

<script>
    
    function updateTrafficEventChart(firewallData) {
      // Extract keys (categories) and values (firewall data) into arrays
      var categories = [];
      var dataValues = [];

      for (var category in firewallData) {
          if (firewallData.hasOwnProperty(category)) {
              for (var subCategory in firewallData[category]) {
                  if (firewallData[category].hasOwnProperty(subCategory)) {
                      categories.push(category + ": " + subCategory);
                      dataValues.push(firewallData[category][subCategory]);
                  }
              }
          }
      }

      // Initialize or update ApexCharts with dynamic data
      var chartElement = document.getElementById('traffic-event-chart');
      if (chartElement.innerHTML === '') {
          new ApexCharts(chartElement, {
              chart: {
                  id: 'traffic-event-chart',
                  type: "bar",
                  fontFamily: 'inherit',
                  height: 300,
                  animations: {
                      enabled: false
                  },
              },
              dataLabels: {
                  enabled: false,
              },
              fill: {
                  opacity: .16,
                  type: 'solid'
              },
              stroke: {
                  width: 2,
                  lineCap: "round",
                  curve: "smooth",
              },
              series: [{
                  name: "Count",
                  data: dataValues // Use dataValues array for chart data
              }],
              tooltip: {
                  theme: 'dark'
              },
              grid: {
                  strokeDashArray: 4,
              },
              xaxis: {
                  labels: {
                      padding: 0,
                  },
                  tooltip: {
                      enabled: false
                  },
                  axisBorder: {
                      show: false,
                  },
                  categories: categories // Use categories array for x-axis categories
              },
              yaxis: {
                  labels: {
                      padding: 4
                  },
              },
              colors: ["#00E396"],
              legend: {
                  show: false,
              },
              annotations: {
                  yaxis: [],
                  xaxis: [],
                  points: [{
                      x: categories[categories.length - 1], // Last category
                      y: Math.max(dataValues), // Maximum value
                      marker: {
                          size: 0
                      },
                      label: {
                        show: false,
                      }
                  }]
              }
          }).render();
      } else {
          ApexCharts.exec('traffic-event-chart', 'updateOptions', {
              xaxis: {
                  categories: categories
              },
              series: [{
                  data: dataValues
              }],
              annotations: {
                  points: [{
                      x: categories[categories.length - 1],
                      y: Math.max(dataValues),
                      marker: {
                          size: 0
                      },
                      label: {
                        show: false,
                      }
                  }]
              }
          });
      }
  }
</script>

{% endblock %}